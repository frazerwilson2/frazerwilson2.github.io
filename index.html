<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAGE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Silkscreen:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: "Silkscreen", sans-serif;
            font-weight: 700;
            font-style: normal;
            background: #ffff9c;
            margin: 20px;
        }
        .posts {
            display: grid;
            gap: 7px;
        }
        @media (min-width: 768px) {
            .posts {
              grid-template-columns: repeat(3, 1fr);
            }
        }
        .posts article {
            border: 5px dashed black;
            padding: 10px;
        }
        .posts article:hover {
            cursor: pointer;
            border-color: gray;
        }
        img {
          max-width: 100%;
        }
        .post-content {
          max-width: 800px;
          margin: 0 2vw;
        }
        h2, h3 {
          font-size: 2rem;
        }
        pre {
          font-size: 2rem;
          white-space: break-spaces;
        }
        p {
          line-height: 1.6;
        }
    </style>
</head>
  <body>
    <div id="posts" class="posts"></div>
    <div id="post-content" class="post-content"></div>
<script
      src="https://cdn.jsdelivr.net/npm/contentful@7.0.5/dist/contentful.browser.min.js"
      charset="utf-8"
    ></script>
    <script>
      var exports = {}; // quick fix because 'exports' is not defined in rich-text bundle below
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/@contentful/rich-text-html-renderer@12.0.0/dist/rich-text-html-renderer.es5.min.js"
      charset="utf-8"
    ></script>
  <script>

    const loadInImg = (id) => {
        fetch(`https://cdn.contentful.com/spaces/fdyzdyn8c696/environments/master/assets/${id}?access_token=EQNUJXNxFK8Q7DBt9nDdooF7PEqvgt5VE0AW4y5DtjA`)
        .then(response => response.json())
        .then(asset => {
          const url = asset.fields.file.url;
          const alt = asset.fields.title || '';
          const imgElement = document.querySelector(`img[data-id="${id}"]`);
          imgElement.src = url;
          imgElement.alt = alt;
        });
    };

const options = {
  renderMark: {
    ['bold']: (text) => `<strong>${text}</strong>`,
    ['code']: (text) => {
      const esc = String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
      return `<pre>${esc}</pre>`;
    },
  },
  renderNode: {
    ['paragraph']: (node, next) =>
      `<p>${next(node.content)}</p>`,
    ['text']: (node, next) =>
      `<p>${next(node.content)}</p>`,
    ['embedded-asset-block']: (node) => {
        loadInImg(node.data.target.sys.id);
        return `<img src="#" alt="" data-id="${node.data.target.sys.id}" />`;
    },
  },
};

    const getArticle = (id) => {
        fetch(`https://cdn.contentful.com/spaces/fdyzdyn8c696/environments/master/entries/${id}?access_token=EQNUJXNxFK8Q7DBt9nDdooF7PEqvgt5VE0AW4y5DtjA`)
            .then(response => response.json())
            .then(data => {
                console.log(data);
                const title = data.fields.title || 'No Title';
                console.log(data.fields.content);
                
                const body = documentToHtmlString(data.fields.content, options) || 'No Content';
                document.getElementById('post-content').innerHTML = `<h2>${title}</h2>${body}`;
                window.location.hash = `#${id}`;
            });
    }
    
    fetch('https://cdn.contentful.com/spaces/fdyzdyn8c696/environments/master/entries?access_token=EQNUJXNxFK8Q7DBt9nDdooF7PEqvgt5VE0AW4y5DtjA')
      .then(response => response.json())
      .then(data => {
          const posts = data.items.map(item => {
          const title = item.fields.title || 'No Title';
          return `<article data-id="${item.sys.id}"><h2>${title}</h2></article>`;
        }).join('');
        document.getElementById('posts').innerHTML = posts;
        document.querySelectorAll('.posts article').forEach(article => {
            article.addEventListener('click', (e) => {
                let postId = e.currentTarget.getAttribute('data-id');
                if(!postId) {
                    while(!postId) {
                        e.currentTarget = e.currentTarget.parentElement;
                        postId = e.currentTarget.getAttribute('data-id');
                    }
                }
                getArticle(postId);
            });
        });
        const hash = window.location.hash;
        if(hash) {
            const postId = hash.substring(1);
            getArticle(postId);
        }
      });
  </script>
  </body>
</html>
